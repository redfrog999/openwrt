#!/bin/sh

# --- 1. RPS/RFS 核心对齐 (让双核四線程協同) ---
# MT7621 是 2核4線程，掩码 'f' (1111) 代表分配给所有逻辑核心
# 这样可以防止单核处理软中断（Softirq）导致 100% 占用卡死
for rps_file in /sys/class/net/*/queues/rx-*/rps_cpus; do
    echo "f" > "$rps_file" 2>/dev/null
done

# 设置流控制数量，防止 RFS 频繁切换上下文导致的 CPU 抖动
echo "2048" > /proc/sys/net/core/rps_sock_flow_entries
for rfc_file in /sys/class/net/*/queues/rx-*/rps_flow_cnt; do
    echo "512" > "$rfc_file" 2>/dev/null
done

# --- 2. 硬件加速 (HNAT/PPE) 衔接逻辑 ---
# 关键：必须确保硬件加速开启，否则 CPU 处理 100M+ 流量必死
# 在 MT7621 上，这通常由内核模块 hw_nat 驱动，我们确保网卡特性开启
for eth in $(ls /sys/class/net | grep -E 'eth|wan|lan'); do
    ethtool -K "$eth" gro on 2>/dev/null
done

# --- 3. 内存管理：弃 KSM 保 zstd ---
# MT7621 只有 128M/256M，KSM 扫描会直接吞掉那点可怜的 MIPS 算力
# 我们强制使用 zstd 压缩，并将 swappiness 调低，减少 I/O 等待
if [ -b /dev/zram0 ]; then
    echo zstd > /sys/block/zram0/comp_algorithm
    echo 60 > /proc/sys/vm/swappiness
fi

# --- 4. 彻底铲除 ICMP 瘀堵 (恢复链路主权) ---
# 恢复默认的 ICMP 处理，确保 MTU 发现机制正常
sysctl -w net.ipv4.icmp_echo_ignore_broadcasts=1
sysctl -w net.ipv4.icmp_ignore_bogus_error_responses=1
sysctl -w net.ipv4.icmp_ratelimit=0  # 设为 0 彻底不限制，保证响应

logger -t "MIPS-Optimizer" "MT7621 内核对齐完成：RPS(掩码F)已衔接 HNAT，ICMP 限制已解除。"
