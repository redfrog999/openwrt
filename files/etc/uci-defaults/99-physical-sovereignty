#!/bin/sh

# --- 1. RPS/RFS 核心对齐 ---
# f = 1111 (4个逻辑核心全开)
for rps_file in /sys/class/net/*/queues/rx-*/rps_cpus; do
    echo "f" > "$rps_file" 2>/dev/null
done

echo "2048" > /proc/sys/net/core/rps_sock_flow_entries
for rfc_file in /sys/class/net/*/queues/rx-*/rps_flow_cnt; do
    echo "512" > "$rfc_file" 2>/dev/null
done

# --- 2. 硬件加速与网卡特性 ---
for eth in $(ls /sys/class/net | grep -E 'eth|wan|lan'); do
    ethtool -K "$eth" gro on 2>/dev/null
done

# --- 3. 内存管理：zram + zstd ---
if [ -b /dev/zram0 ]; then
    swapoff /dev/zram0 2>/dev/null
    echo 1 > /sys/block/zram0/reset 2>/dev/null
    # 强制检查并设置 zstd
    [ -f /sys/block/zram0/comp_algorithm ] && echo zstd > /sys/block/zram0/comp_algorithm
    TOTAL_MEM=$(free | grep Mem | awk '{print $2}')
    # 分配 50% 内存作为压缩 Swap
    echo "$((TOTAL_MEM / 2 * 1024))" > /sys/block/zram0/disksize
    mkswap /dev/zram0 >/dev/null
    swapon -p 10 /dev/zram0
fi

# --- 4. 链路主权恢复 ---
sysctl -w net.ipv4.icmp_echo_ignore_broadcasts=1
sysctl -w net.ipv4.icmp_ignore_bogus_error_responses=1
sysctl -w net.ipv4.icmp_ratelimit=0

# --- 5. MT7621 养老与 TCP 调优 ---
cat <<EOF >> /etc/sysctl.conf
net.netfilter.nf_conntrack_max=65535
net.netfilter.nf_conntrack_tcp_timeout_established=600
net.netfilter.nf_conntrack_tcp_timeout_close_wait=30
net.core.rmem_max=16777216
net.core.wmem_max=16777216
net.ipv4.tcp_rmem=4096 87380 16777216
net.ipv4.tcp_wmem=4096 65536 16777216
net.core.netdev_max_backlog=2048
net.ipv4.tcp_fastopen=3
net.core.default_qdisc=fq_codel
net.ipv4.tcp_congestion_control=bbr
# 优化 VFS 压力与脏数据比例，保护 130MB 健康水位
vfs_cache_pressure=125
vm/dirty_ratio=10
dirty_background_ratio=5
vm.swappiness=100
EOF
sysctl -p

#!/bin/sh

# --- 6.MT7615分离调用实现异构加速及Kernel极度优化调参
#!/bin/sh

# ---------------------------------------------------------
# 1. 中断主权隔离 (针对双 MT7615 异构分流)
# ---------------------------------------------------------
# A. 禁用硬件卸载 (针对无线中继模式的兼容性，防止与无线驱动抢占总线)
uci set network.globals.packet_steering='1'
uci set firewall.@defaults[0].flow_offloading='0'
uci set firewall.@defaults[0].flow_offloading_hw='0'
uci commit firewall

# B. 中断绑定 (IRQ Affinity) - 硬合作模式
# MT7621 是双核四线程，核心 0/1 是物理核心，2/3 是逻辑线程
# 我们将两颗 MT7615 的中断强行剥离到不同的物理核心上
# 脚本自动获取 MT7615 的 IRQ 号并绑定
logger "Configuring IRQ Affinity for Dual MT7615..."

IRQ_WIFI_A=$(grep -m 1 "mt7615" /proc/interrupts | awk '{print $1}' | tr -d ':')
IRQ_WIFI_B=$(grep "mt7615" /proc/interrupts | sed -n '2p' | awk '{print $1}' | tr -d ':')

if [ ! -z "$IRQ_WIFI_A" ]; then
    echo 1 > /proc/irq/$IRQ_WIFI_A/smp_affinity  # 绑定第一块卡到 CPU0
fi

if [ ! -z "$IRQ_WIFI_B" ]; then
    echo 2 > /proc/irq/$IRQ_WIFI_B/smp_affinity  # 绑定第二块卡到 CPU1
fi

# C. 软中断聚合与 RPS/RFS 调优 (针对 4K HDR 大包流量)
# 为所有以太网和无线接口开启多核接收调度
for dev in eth0 ra0 rai0 ra1 rai1; do
    if [ -d "/sys/class/net/$dev" ]; then
        echo f > /sys/class/net/$dev/queues/rx-0/rps_cpus
        echo 4096 > /sys/class/net/$dev/queues/rx-0/rps_flow_cnt
    fi
done
echo 32768 > /proc/sys/net/core/rps_sock_flow_entries


# D. 针对应用层隧道的“气流”优化
# 确保隧道接口启用全核调度
cat <<EOF > /etc/hotplug.d/iface/99-tunnel-tuning
[ "\$ACTION" = "ifup" ] && {
    echo f > /sys/class/net/\$INTERFACE/queues/rx-0/rps_cpus 2>/dev/null
}
EOF
# ---------------------------------------------------------
# 2. 硬件层 Ring Buffer 扩容 (ethtool 注入)
# ---------------------------------------------------------
# 直接将以太网物理接口的收发描述符队列拉满到 2048
if command -v ethtool >/dev/null 2>&1; then
    ethtool -G eth0 rx 2048 tx 2048 >/dev/null 2>&1
fi

# ---------------------------------------------------------
# 3. 链路聚合哈希与接口发送队列调优
# ---------------------------------------------------------
# 强制 L3+L4 哈希策略
if [ -d /sys/class/net/bond0 ]; then
    echo "layer3+4" > /sys/class/net/bond0/bonding/xmit_hash_policy
fi
# 设置监控频率，确保链路故障时秒级切换
    echo 100 > /sys/class/net/bond0/bonding/miimon
fi
# 增加接口发送队列长度，配合 PPE 降低软中断负载
for dev in ra0 rai0 bond0 eth0; do
    if ifconfig $dev > /dev/null 2>&1; then
        ifconfig $dev txqueuelen 2048
    fi

# ---------------------------------------------------------
# 4. 中断合并调优 (Interrupt Coalescing)
# ---------------------------------------------------------
# 让网卡每积攒 16 个包或者每过 50 微秒才去“烦”一次 CPU
if command -v ethtool >/dev/null 2>&1; then
    ethtool -C eth0 rx-frames 16 rx-usecs 50 tx-frames 16 tx-usecs 50 >/dev/null 2>&1
fi
done

# --- 7. 无线环境极致固化 ---
for radio in $(uci show wireless | grep =wifi-device | cut -d. -f2 | cut -d= -f1); do
    uci set wireless.${radio}.noscan='1'
    uci set wireless.${radio}.country='AU'
    uci set wireless.${radio}.legacy_rates='0'
    uci set wireless.${radio0}.bgscan='0' 
done

logger -t "MIPS-Optimizer" "MT7621 内核对齐完成：RPS(掩码F)已衔接，MRS 规则已对位。"
exit 0
